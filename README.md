# Сайт-платформа по предоставлению пользователям картин, сгенерированных нейронной сетью



## Стек
- django
- postgresql
- redis
- Celery

## Зависимости

В файле requirements.txt

## Запуск


## ТЗ

 Нужно создать с нуля проект, сделать его в минималистическом виде, завернуть его части
 в докеры и после задеплоить для демонстрации-теста. 
 
 Разрабатываем сайт-платформу по 
 предоставлению пользователям картин, сгенерированных нейронной сетью.
 Сайт как минимум должен содержать каталог примеров (+-10 примеров), предоставлять возможность 
 зарегистрироваться и поставить задачу на генерацию картины на основе краткого текста-описания
 от пользователя. Задание и сгенерированная картина появится в кабинете пользователя.
 Предполагаем, что на сайт будут ходить большое количество пользователей. 
 Доступ к Микросервису, который умеет по небольшому описанию генерировать 
 картину-изображение - предоставим. С микросервисом можно будет общаться по restapi.
 Дизайн и структура сайта на ваше усмотрение. 


# Микросервис для генерации изображений
208.51.60.18:2020 - img_generator

Микросервис предназначен для генерации изображений на основе текстовых описаний. Для этого применяется открытая предобученная модель StableDiffusion. При запуске модели микросервис применяет Nvidia CUDA (необходимо [установить соответствующее ПО](https://developer.nvidia.com/cuda-downloads) на сервере, доступно через APT).

Генерация описаний производится при помощи [CLIP](https://github.com/openai/CLIP) (следует установить на сервере отдельно при помощи Pip) и [BLIP](https://github.com/pharmapsychotic/BLIP). Cодержимое репозитория BLIP размещено в каталоге "src\Interrogator_files\blip".

Апскейлинг изображений производится при помощи [Real-ESRGAN](https://github.com/xinntao/Real-ESRGAN). Cодержимое репозитория Real-ESRGAN должно быть размещено в каталоге "src\Interrogator\Upscaler_files\esrgan". Перед первым запуском из директории с содержимым репозитория следует исполнить следующую команду:

    python setup.py develop

После запуска генерация первого изображения или первого описания может занять несколько десятков минут, так как микросервису необходимо предварительно скачать все необходимые модели.

## Запросы к микросервису

### 1) Запрос создания заявки на генерацию изображения (POST, /initiate_processing)

* prompt — (text) текст, описывающий желаемое изображение, параметр опционален только если новые изображения не генерируются;
* neg_prompt — (text) текст, описывающий нежелательные детали или характеристики изображения;
* ups — (int) множитель разрешения при апскейлинге (4 по умолчанию увеличивает в 16 раз, 1 или менее для отключения апскейлинга);
* imgs — (text, text list) изображение (или их список) в формате PNG или JPG в виде байтов с кодированием Base64, на основе которого будет сгенерировано новое (img2img генерация);
* strength — (float) выраженность изменений для img2img генерации относительно исходного изображения (от 0 до 1);
* n — (int) количество изображений;
* height — (int) высота изображения в пикселях, должна быть кратна 8;
* width — (int) ширина изображения в пикселях, должна быть кратна 8;
* steps — (int) число шагов при генерации изображения;
* scale — (float) степень соответствия изображения тексту;
* seed — (int) зерно генерации изображения;
* desc — (bool) генерировать ли описание изображения;
* cpu — (bool) принудительное использование CPU (не рекомендуется);
* blip_max_len — (int) максимальное количество токенов в описании, получаемом при помощи модели BLIP (не менее 5);
* clip_max_len — (int) максимальное количество дополнительных фраз в описании, получаемом при помощи модели CLIP (не менее 0);
* skip_clip — (bool) отказ от генерации детализированных описаний при помощи модели CLIP;
* skip_list — (text list) отказ от перечисленных элементов описаний CLIP (возможные элементы: "mediums", "artists", "trendings", "movements").

Ответ: номер заявки.

### 2) Запрос на проверку статуса заявки (POST, /check_status)

* id — (int) номер заявки.

Ответ: статус заявки (в текстовом виде).

Статусы заявки:

* queue position: n — позиция заявки в очереди на обработку (n — номер позиции);
* processing — заявка в обработке;
* finished — обработка заявки завершена;
* error — ошибка при обработки заявки.

### 3) Запрос для получения результатов обработки заявки (POST, /get_results)

* id — (int) номер заявки.

Ответ: словарь с результатами.

Ключи словаря с результатами:

* imgs — список изображений в формате PNG, каждое из которых представлено в виде байтов с кодированием Base64;
* descs — список описаний изображений.

## Справка по параметрам запросов создания заявок на генерацию изображений

* Все параметры являются опциональными;
* Предпочтительно задавать одинаковые значения для высоты и ширины изображения не ниже 512 (при этом повышение разрешения значительно увеличивает требования к видеопамяти).
* Отдельные группы слов текстовых описаний можно выделять круглыми скобками для увеличения их влияния или квадратными для ослабления. Можно усилить данный эффект, используя сразу несколько пар скобок.
* Повышение числа шагов дает лучшие результаты в плане шума, но за более длительное время (оптимально 50).
* Степень соответствия тексту может снижать качество и разнообразие результатов (оптимально 7—8).
* При задании одного и того же значения зерна можно получать повторные результаты.
* При выраженности изменений для img2img генерации ниже нуля генерация нового изображения не производится, а если значение ниже -1, то неизмененное изображение не отсылается назад.

## Тестовый клиент

Тестовый клиент tester.py связывается с сервером по адресу, который указан в переменной url, создает заявку на генерацию изображений, опрашивает сервер о статусе ее выполнения, получает результат, декодирует его и сохраняет полученные изображения и описания в папке "results".


